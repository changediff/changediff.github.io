<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>changediff | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.1.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">changediff</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            利用kube-state-metrics自动生成prometheus的配置文件
        </div>
        <div class="post-meta">
            2021-02-09
        </div>
    

    <div class="post-md">
        <p>最近运维的k8s集群的node节点变动频繁，总是要手动更新prometheus配置文件表示很蛋疼。所以研究一下怎么对node节点做service discovery，自动更新监控targets列表。</p>
<h2 id="先看看已有的配置维护方案"><a href="#先看看已有的配置维护方案" class="headerlink" title="先看看已有的配置维护方案"></a>先看看已有的配置维护方案</h2><p>prometheus的配置通过<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config">file_sd_config</a>实现动态加载，用Python脚本访问每个集群的apiserver获取node节点然后生成对应的json配置文件。</p>
<p>这个方案可以拿来直接用的，不过配置起来不够灵活。我不想在脚本里面维护各个集群的认证方式，只想安安静静的更新prometheus自己的配置。pass</p>
<h2 id="再看看prometheus官方提供的方案"><a href="#再看看prometheus官方提供的方案" class="headerlink" title="再看看prometheus官方提供的方案"></a>再看看prometheus官方提供的方案</h2><p>prometheus提供了<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">kubernetes_sd_config</a>，可以在prometheus.yml中配置好集群的认证方式，这样prometheus会定期去各个apiserver获取需要监控的node列表。在测试环境折腾了半天，发现这种方式对于部署在内部的prometheus配置起来很友好，然后如果是多个集群共用一个prometheus的话认证证书维护起来比较麻烦且容易出现集群认证配置更新了，prometheus中的配置没更新的尴尬情况。虽说集群的认证更新不会很频繁，但是每次更新就得重启prometheus也是不方便。</p>
<p>所以这种的确是最优雅的方案，也被pass了。</p>
<h2 id="我的方案"><a href="#我的方案" class="headerlink" title="我的方案"></a>我的方案</h2><p>最后在研究promethes的各个监控项目的时候，发现了kubernetes官方提供了详细的node节点监控：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md">kube-state-metrics</a>，这些监控配置同样可以通过file_sd_config动态加载。于是有了以下方案：</p>
<blockquote>
<p>人工维护kube-state-metrics的配置<code>groups/kube-state-metrics/*.json</code>，使用定时执行的脚本通过获取localhost的prometheus监控数据来更新node列表</p>
</blockquote>
<h3 id="prometheus部署"><a href="#prometheus部署" class="headerlink" title="prometheus部署"></a>prometheus部署</h3><ul>
<li><p>prometheus.yaml中必备配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     60s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  scrape_timeout: 60s</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line">  # Attach these labels to any time series or alerts when communicating with</span><br><span class="line">  # external systems (federation, remote storage, Alertmanager).</span><br><span class="line">  external_labels:</span><br><span class="line">      monitor: &#x27;k8s-prometheus-monitor&#x27;</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: [&quot;localhost:9093&quot;]</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first.rules&quot;</span><br><span class="line">  # - &quot;second.rules&quot;</span><br><span class="line">  - /home/server/prometheus/rule.yml</span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#x27;s Prometheus itself.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#x27;/metrics&#x27;</span><br><span class="line">    # scheme defaults to &#x27;http&#x27;.</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;kube-state-metrics&#x27;</span><br><span class="line">    scrape_interval: 180s</span><br><span class="line">    scrape_timeout:  30s</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;groups/kube-state-metrics/*.json&#x27;]</span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;(kube_node_status_condition|kube_node_labels|kube_node_info|kube_pod_container_resource_requests_cpu_cores|kube_node_status_allocatable_cpu_cores|kube_pod_container_resource_requests_memory_bytes|kube_node_status_allocatable_memory_bytes)&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;cadvisor&#x27;</span><br><span class="line">    scrape_interval: 90s</span><br><span class="line">    scrape_timeout:  30s</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;groups/cadvisor/*.json&#x27;]</span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;(container_cpu_usage_seconds_total|container_memory_rss|container_memory_usage_bytes|container_spec_memory_limit_bytes|container_spec_cpu_quota|container_memory_swap|container_memory_cache|container_network_receive_bytes_total|container_network_transmit_bytes_total|container_cpu_cfs_throttled_periods_total|container_cpu_cfs_periods_total|container_cpu_user_seconds_total|container_cpu_system_seconds_total|container_memory_failures_total|container_fs_reads_bytes_total|container_fs_writes_bytes_total|container_cpu_cfs_throttled_seconds_total|container_memory_working_set_bytes|kube_deployment_spec_replicas|kube_node_status_capacity_cpu_cores|kube_pod_container_resource_limits|kube_pod_container_resource_limits_cpu_cores|kube_pod_container_resource_limits_memory_bytes|kube_pod_container_resource_requests|kube_pod_container_resource_requests_cpu_cores|kube_replicationcontroller_spec_replicas|kube_replicationcontroller_status_replicas)&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">  # kubernetes &gt; 1.13</span><br><span class="line">  - job_name: &#x27;cadvisor-standalone&#x27;</span><br><span class="line">    scrape_interval: 90s</span><br><span class="line">    scrape_timeout:  30s</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;groups/cadvisor-standalone/*.json&#x27;]</span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      - source_labels: [&#x27;container_label_io_kubernetes_pod_name&#x27;]</span><br><span class="line">        target_label: &#x27;pod_name&#x27;</span><br><span class="line">      - source_labels: [&#x27;container_label_io_kubernetes_container_name&#x27;]</span><br><span class="line">        target_label: &#x27;container_name&#x27;</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;(container_cpu_usage_seconds_total|container_memory_rss|container_memory_usage_bytes|container_spec_memory_limit_bytes|container_spec_cpu_quota|container_memory_swap|container_memory_cache|container_network_receive_bytes_total|container_network_transmit_bytes_total|container_cpu_cfs_throttled_periods_total|container_cpu_cfs_periods_total|container_cpu_user_seconds_total|container_cpu_system_seconds_total|container_memory_failures_total|container_fs_reads_bytes_total|container_fs_writes_bytes_total|container_cpu_cfs_throttled_seconds_total|container_memory_working_set_bytes|kube_deployment_spec_replicas|kube_node_status_capacity_cpu_cores|kube_pod_container_resource_limits|kube_pod_container_resource_limits_cpu_cores|kube_pod_container_resource_limits_memory_bytes|kube_pod_container_resource_requests|kube_pod_container_resource_requests_cpu_cores|kube_replicationcontroller_spec_replicas|kube_replicationcontroller_status_replicas)&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;node-exporter&#x27;</span><br><span class="line">    scrape_interval: 90s</span><br><span class="line">    scrape_timeout:  30s</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;groups/node-exporter/*.json&#x27;]</span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;(node_cpu_seconds_total|node_memory_MemAvailable_bytes|node_memory_MemTotal_bytes|node_load1|node_load5)&quot;</span><br><span class="line">        action: keep</span><br></pre></td></tr></table></figure>

</li>
<li><p>docker-comose.yaml配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">prometheus:</span><br><span class="line">  image: prom/prometheus:v2.24.1</span><br><span class="line">  net: host</span><br><span class="line">  restart: always</span><br><span class="line">  environment:</span><br><span class="line">   -  TZ=Asia/Shanghai</span><br><span class="line">  volumes:</span><br><span class="line">   -  /etc/localtime:/etc/localtime:ro</span><br><span class="line">   - ./prometheus/:/etc/prometheus/</span><br><span class="line">   - /home/data/prometheus_data/:/prometheus_data/:rw</span><br><span class="line">  command:</span><br><span class="line">   - &#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span><br><span class="line">   - &#x27;--storage.tsdb.path=/prometheus_data/&#x27;</span><br><span class="line">   - &#x27;--storage.tsdb.retention.time=2d&#x27;</span><br><span class="line">   - &#x27;--storage.tsdb.max-block-duration=2h&#x27;</span><br><span class="line">   - &#x27;--storage.tsdb.min-block-duration=2h&#x27;</span><br><span class="line">   - &#x27;--query.max-samples=100000000&#x27;</span><br><span class="line">   - &#x27;--web.console.libraries=/usr/share/prometheus/console_libraries&#x27;</span><br><span class="line">   - &#x27;--web.console.templates=/usr/share/prometheus/consoles&#x27;</span><br><span class="line">  ports:</span><br><span class="line">   - 9090:9090</span><br><span class="line"></span><br><span class="line">alertmanager:</span><br><span class="line">  image: prom/alertmanager</span><br><span class="line">  ports:</span><br><span class="line">    - 9093:9093</span><br><span class="line">  volumes:</span><br><span class="line">    - ./alertmanager/:/etc/alertmanager/</span><br><span class="line">  net: host</span><br><span class="line">  restart: always</span><br><span class="line">  command:</span><br><span class="line">    - &#x27;--config.file=/etc/alertmanager/config.yml&#x27;</span><br><span class="line">    - &#x27;--storage.path=/alertmanager&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>启动脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">mkdir -p /home/server/prometheus/groups/&#123;kube-state-metrics,node-exporter,cadvisor,cadvisor-standalone&#125;</span><br><span class="line">mkdir -p /home/data/prometheus_data/</span><br><span class="line">mkdir -p /home/server/alertmanager/</span><br></pre></td></tr></table></figure></li>
<li><p>Python脚本生成node配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"># coding: utf-8</span><br><span class="line"></span><br><span class="line">import json</span><br><span class="line">import socket</span><br><span class="line">import time</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def send_alarm(msg):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def simple_query(query=&#x27;kube_node_status_condition&#123;status=&quot;true&quot;&#125;==1&#x27;):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    获取5分钟前的监控数据</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    step = 20</span><br><span class="line">    now = int(time.time())</span><br><span class="line">    start = now - 300</span><br><span class="line">    end = now - 300</span><br><span class="line">    params = (</span><br><span class="line">        (&#x27;query&#x27;, str(query)),</span><br><span class="line">        (&#x27;start&#x27;, str(start)),</span><br><span class="line">        (&#x27;end&#x27;, str(end)),</span><br><span class="line">        (&#x27;step&#x27;, str(step)),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    response = requests.get(</span><br><span class="line">        &#x27;http://localhost:9090/api/v1/query_range&#x27;, params=params)</span><br><span class="line"></span><br><span class="line">    if response:</span><br><span class="line">        return response.json()</span><br><span class="line">    else:</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def json_node_exporter_cadvisor():</span><br><span class="line">    kube_node_status_condition = simple_query(</span><br><span class="line">        query=&#x27;kube_node_status_condition&#123;status=&quot;true&quot;&#125;==1&#x27;)</span><br><span class="line">    kube_node_labels = simple_query(query=&#x27;kube_node_labels&#x27;)</span><br><span class="line">    kube_node_info = simple_query(query=&#x27;kube_node_info&#x27;)</span><br><span class="line">    try:</span><br><span class="line">        cluster_count_old = &#123;&#125;</span><br><span class="line">        with open(&quot;/home/server/prometheus/groups/node-exporter/config_node_exporter.json&quot;) as f:</span><br><span class="line">            config = json.loads(f.read())</span><br><span class="line">            for node in config:</span><br><span class="line">                cluster = node[&quot;labels&quot;][&quot;cluster&quot;]</span><br><span class="line">                if cluster not in cluster_count_old:</span><br><span class="line">                    cluster_count_old[cluster] = 1</span><br><span class="line">                else:</span><br><span class="line">                    cluster_count_old[cluster] += 1</span><br><span class="line">    except:</span><br><span class="line">        cluster_count_old = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        nodes_ready = [i[&quot;metric&quot;][&quot;node&quot;]</span><br><span class="line">                       for i in kube_node_status_condition[&quot;data&quot;][&quot;result&quot;]]</span><br><span class="line">        node_label_dict = &#123;</span><br><span class="line">            i[&quot;metric&quot;][&quot;node&quot;]: &#123;</span><br><span class="line">                &quot;cluster&quot;: i[&quot;metric&quot;][&quot;cluster&quot;],</span><br><span class="line">                &quot;group&quot;: i[&quot;metric&quot;].get(&quot;label_group&quot;)</span><br><span class="line">            &#125; for i in kube_node_labels[&quot;data&quot;][&quot;result&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        node_version_dict = &#123;</span><br><span class="line">            i[&quot;metric&quot;][&quot;node&quot;]: str(</span><br><span class="line">                i[&quot;metric&quot;][&quot;kubelet_version&quot;]).strip(&quot;v&quot;).split(&quot;.&quot;)</span><br><span class="line">            for i in kube_node_info[&quot;data&quot;][&quot;result&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        config_node_exporter = []</span><br><span class="line">        config_cadvisor = []</span><br><span class="line">        config_cadvisor_standalone = []</span><br><span class="line">        cluster_count_new = &#123;&#125;</span><br><span class="line">        for n in nodes_ready:</span><br><span class="line">            targets_9100 = [str(n) + &quot;:9100&quot;]</span><br><span class="line">            targets_4194 = [str(n) + &quot;:4194&quot;]</span><br><span class="line">            version = node_version_dict[n]</span><br><span class="line">            cluster = node_label_dict[n][&quot;cluster&quot;]</span><br><span class="line">            if cluster not in cluster_count_new:</span><br><span class="line">                cluster_count_new[cluster] = 1</span><br><span class="line">            else:</span><br><span class="line">                cluster_count_new[cluster] += 1</span><br><span class="line">            item_node = &#123;&quot;labels&quot;: node_label_dict[n], &quot;targets&quot;: targets_9100&#125;</span><br><span class="line">            item_cadvisor = &#123;</span><br><span class="line">                &quot;labels&quot;: node_label_dict[n], &quot;targets&quot;: targets_4194&#125;</span><br><span class="line">            config_node_exporter.append(item_node)</span><br><span class="line">            if int(version[1]) == 1 and int(version[1]) &gt;= 14:</span><br><span class="line">                config_cadvisor_standalone.append(item_cadvisor)</span><br><span class="line">            else:</span><br><span class="line">                config_cadvisor.append(item_cadvisor)</span><br><span class="line"></span><br><span class="line">        cluster_config_change = &#123;</span><br><span class="line">            cluster: cluster_count_new.get(cluster, 0) - cluster_count_old.get(cluster) for cluster in cluster_count_old</span><br><span class="line">        &#125;</span><br><span class="line">        change_min = min(list(cluster_config_change.values()))</span><br><span class="line">        if change_min &gt;= -3:  #node节点减少如果大于3个则不自动更新配置</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/node-exporter/config_node_exporter.json&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_node_exporter, indent=4))</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/cadvisor/config_cadvisor.json&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_cadvisor, indent=4))</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/cadvisor-standalone/config_cadvisor_standalone.json&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_cadvisor_standalone, indent=4))</span><br><span class="line">        else:</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/node-exporter/config_node_exporter.json.new&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_node_exporter, indent=4))</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/cadvisor/config_cadvisor.json.new&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_cadvisor, indent=4))</span><br><span class="line">            with open(&quot;/home/server/prometheus/groups/cadvisor-standalone/config_cadvisor_standalone.json.new&quot;, &quot;w&quot;) as f:</span><br><span class="line">                f.write(json.dumps(config_cadvisor_standalone, indent=4))</span><br><span class="line"></span><br><span class="line">            msg = &quot;prometheus配置中node数量变更为&#123;&#125;，请确认配置: &#123;&#125;&quot;.format(str(change_min), str(cluster_config_change))</span><br><span class="line">            send_alarm(msg)</span><br><span class="line">        return cluster_config_change</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    res = json_node_exporter_cadvisor()</span><br><span class="line">    print(res)</span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

</div>
                <div class="footer">
    <span>Copyright © 2022 changediff</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">這Li</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    </body>
</html>