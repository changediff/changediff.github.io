<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>changediff | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.1.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">changediff</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            CentOS7升级systemd版本到416.1
        </div>
        <div class="post-meta">
            2022-04-17
        </div>
    

    <div class="post-md">
        <p>本文主要记录下在CentOS7折腾升级systemd的过程中踩得坑，方便以后需要的时候能够快速复盘。CentOS7中默认开启cgorupv2需要升级systemd版本，当前最靠谱的升级方式为Facebook维护的<a target="_blank" rel="noopener" href="https://github.com/facebookarchive/rpm-backports">backports</a></p>
<p>具体打包过程中见<a target="_blank" rel="noopener" href="https://github.com/changediff/rpm-backports">GitHub</a></p>
<h2 id="0-搭建本地仓库"><a href="#0-搭建本地仓库" class="headerlink" title="0. 搭建本地仓库"></a>0. 搭建本地仓库</h2><p>打包好的rpm包在repo目录下，可以使用createrepo命令快速搭建自定义mirror</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建repodate</span></span><br><span class="line">createrepo repo/</span><br><span class="line"><span class="built_in">cd</span> repo</span><br><span class="line"><span class="comment"># 启动http服务提供本地rpm源服务</span></span><br><span class="line"><span class="built_in">nohup</span> python -m SimpleHTTPServer &amp;</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF | tee /etc/yum.repos.d/localhost</span></span><br><span class="line"><span class="string">[localhost]</span></span><br><span class="line"><span class="string">name=localhost</span></span><br><span class="line"><span class="string">baseurl=http://127.0.0.1:8000/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>在此基础上，新增配置<a target="_blank" rel="noopener" href="https://mirrors.ustc.edu.cn/help/epel.html">epel repo</a>和<a target="_blank" rel="noopener" href="http://elrepo.org/tiki/HomePage">elrepo</a></p>
<p>完成源配置之后，参考步骤1到3可在CentOS7.9系统上复现打包过程</p>
<h2 id="1-安装并配置mock"><a href="#1-安装并配置mock" class="headerlink" title="1. 安装并配置mock"></a>1. 安装并配置mock</h2><h3 id="工具包安装"><a href="#工具包安装" class="headerlink" title="工具包安装"></a>工具包安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install fedora-packager</span><br></pre></td></tr></table></figure>

<h3 id="自定义源配置"><a href="#自定义源配置" class="headerlink" title="自定义源配置"></a>自定义源配置</h3><p>自定义源配置如下，&#x3D;&#x3D;注意先启动本地rpm源服务&#x3D;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/mock</span><br><span class="line"><span class="comment"># 查看默认配置</span></span><br><span class="line">mock]<span class="comment"># cat default.cfg</span></span><br><span class="line">include(<span class="string">&#x27;templates/epel-7.tpl&#x27;</span>)</span><br><span class="line"></span><br><span class="line">config_opts[<span class="string">&#x27;root&#x27;</span>] = <span class="string">&#x27;epel-7-x86_64&#x27;</span></span><br><span class="line">config_opts[<span class="string">&#x27;target_arch&#x27;</span>] = <span class="string">&#x27;x86_64&#x27;</span></span><br><span class="line">config_opts[<span class="string">&#x27;legal_host_arches&#x27;</span>] = (<span class="string">&#x27;x86_64&#x27;</span>,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加自定义源</span></span><br><span class="line"><span class="built_in">cp</span> templates/epel-7.tpl templates/epel-7.tpl.bak</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF | tee templates/epel-7.tpl</span></span><br><span class="line"><span class="string">include(&#x27;templates/centos-7.tpl&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">config_opts[&#x27;chroot_setup_cmd&#x27;] = &#x27;install @buildsys-build&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">config_opts[&#x27;yum.conf&#x27;] += &quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[localhost]</span></span><br><span class="line"><span class="string">name=localhost</span></span><br><span class="line"><span class="string">baseurl=http://127.0.0.1:8000/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[epel]</span></span><br><span class="line"><span class="string">name=Extra Packages for Enterprise Linux \$releasever - \$basearch</span></span><br><span class="line"><span class="string">mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-7&amp;arch=\$basearch</span></span><br><span class="line"><span class="string">failovermethod=priority</span></span><br><span class="line"><span class="string">gpgkey=file:///usr/share/distribution-gpg-keys/epel/RPM-GPG-KEY-EPEL-7</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">skip_if_unavailable=False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[epel-testing]</span></span><br><span class="line"><span class="string">name=Extra Packages for Enterprise Linux \$releasever - Testing - \$basearch</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=testing-epel7&amp;arch=\$basearch</span></span><br><span class="line"><span class="string">failovermethod=priority</span></span><br><span class="line"><span class="string">skip_if_unavailable=False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[local]</span></span><br><span class="line"><span class="string">name=local</span></span><br><span class="line"><span class="string">baseurl=https://kojipkgs.fedoraproject.org/repos/epel7-build/latest/\$basearch/</span></span><br><span class="line"><span class="string">cost=2000</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">skip_if_unavailable=False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[epel-debuginfo]</span></span><br><span class="line"><span class="string">name=Extra Packages for Enterprise Linux \$releasever - \$basearch - Debug</span></span><br><span class="line"><span class="string">mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-debug-7&amp;arch=\$basearch</span></span><br><span class="line"><span class="string">failovermethod=priority</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">skip_if_unavailable=False</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>


<h2 id="2-制作dependencies的rpm包"><a href="#2-制作dependencies的rpm包" class="headerlink" title="2. 制作dependencies的rpm包"></a>2. 制作dependencies的rpm包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd dependencies</span><br><span class="line">mock --rebuild curl-7.49.0-1.fc25.src.rpm</span><br><span class="line">cp /var/lib/mock/epel-7-x86_64/result/*.rpm repo</span><br></pre></td></tr></table></figure>

<h2 id="3-制作backport-rpm包"><a href="#3-制作backport-rpm包" class="headerlink" title="3. 制作backport rpm包"></a>3. 制作backport rpm包</h2><h3 id="部分包的编译顺序有依赖"><a href="#部分包的编译顺序有依赖" class="headerlink" title="部分包的编译顺序有依赖"></a>部分包的编译顺序有依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">util-linux --&gt; systemd-compat-libs</span><br><span class="line">rpm-4.13.1 --&gt; systemd</span><br><span class="line"></span><br><span class="line"># 已不用编译python34的依赖，修改spec文件改用python36</span><br><span class="line"># python34-cssselect --&gt; python34-lxml --&gt; systemd --&gt; dbus-broker</span><br></pre></td></tr></table></figure>

<h3 id="编译命令"><a href="#编译命令" class="headerlink" title="编译命令"></a>编译命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 下载源代码</span><br><span class="line">spectool -g -R rpms/systemd/specfiles/systemd.spec</span><br><span class="line"># 打包src.rpm</span><br><span class="line">rpmbuild -bs rpms/systemd/specfiles/systemd.spec</span><br><span class="line"># 使用src.rpm打包二进制rpm</span><br><span class="line">mock --rebuild /root/rpmbuild/SRPMS/systemd-246.1-1.fb7.src.rpm</span><br></pre></td></tr></table></figure>

<h2 id="4-其他说明"><a href="#4-其他说明" class="headerlink" title="4. 其他说明"></a>4. 其他说明</h2><h3 id="4-1-包维护说明"><a href="#4-1-包维护说明" class="headerlink" title="4.1 包维护说明"></a>4.1 包维护说明</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>fedora历史版本src.rpm下载</td>
<td><a target="_blank" rel="noopener" href="https://koji.fedoraproject.org/koji/index">https://koji.fedoraproject.org/koji/index</a></td>
</tr>
<tr>
<td>centos历史版本src.rpm下载</td>
<td><a target="_blank" rel="noopener" href="https://cbs.centos.org/koji/index">https://cbs.centos.org/koji/index</a></td>
</tr>
<tr>
<td>spec规范文档</td>
<td><a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/packaging-guidelines/">https://docs.fedoraproject.org/en-US/packaging-guidelines/</a></td>
</tr>
</tbody></table>
<h3 id="4-2-systemd安装注意点"><a href="#4-2-systemd安装注意点" class="headerlink" title="4.2 systemd安装注意点"></a>4.2 systemd安装注意点</h3><ol>
<li>想要默认启动systemd，需要确保initrd启动调用的systemd为打包后的版本，通过<code>dmesg</code>可以查看。具体参考<a target="_blank" rel="noopener" href="https://github.com/systemd/systemd/issues/19760">issue</a></li>
<li>升级systemd，注意要<strong>先升级systemd</strong>再升级内核，不然需要在重启后用dracut工具重新生成initrd</li>
</ol>

    </div>

</div>
                <div class="footer">
    <span>Copyright © 2022 changediff</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">這Li</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    </body>
</html>